<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CBE Data Portal & FX Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { --cbe-blue: #003366; --cbe-gold: #c5a059; }
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        
        /* Dashboard Styling */
        .status-bar { background: var(--cbe-blue); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 12px; text-align: left; color: #64748b; font-size: 11px; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        
        /* Exchange Rate Section */
        .fx-btn { background: var(--cbe-gold); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .fx-btn:hover { background: #b08e4d; }
        #fx-table { display: none; margin-top: 15px; border-top: 3px solid var(--cbe-gold); }
        .rate-up { color: #10b981; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="status-bar">
        <span id="status">⏳ Connecting to yoo.pdf...</span>
        <button class="fx-btn" onclick="toggleFX()">View Live Exchange Rates (EGP)</button>
    </div>

    <div id="fx-table" class="card">
        <table>
            <thead>
                <tr><th>Currency Pair</th><th>Buy Rate</th><th>Sell Rate</th><th>Market Status</th></tr>
            </thead>
            <tbody id="fx-body">
                <tr><td>USD / EGP</td><td id="usd-buy">Loading...</td><td id="usd-sell">Loading...</td><td>Live Interbank</td></tr>
                <tr><td>EUR / EGP</td><td id="eur-buy">Loading...</td><td id="eur-sell">Loading...</td><td>Live Interbank</td></tr>
                <tr><td>GBP / EGP</td><td id="gbp-buy">Loading...</td><td id="gbp-sell">Loading...</td><td>Live Interbank</td></tr>
            </tbody>
        </table>
    </div>

    <div id="output"></div>
</div>

<script>
    const PDF_PATH = 'yoo.pdf';
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    // 1. Toggle Exchange Rate Table
    async function toggleFX() {
        const table = document.getElementById('fx-table');
        if (table.style.display === "block") {
            table.style.display = "none";
        } else {
            table.style.display = "block";
            fetchRates();
        }
    }

    // 2. Fetch Live EGP Rates (Simulated via public API endpoint logic)
    async function fetchRates() {
        try {
            // Using a public exchange rate API (USD base)
            const response = await fetch('https://open.er-api.com/v6/latest/USD');
            const data = await response.json();
            const egpRate = data.rates.EGP;
            
            document.getElementById('usd-buy').innerText = (egpRate - 0.10).toFixed(4);
            document.getElementById('usd-sell').innerText = (egpRate + 0.05).toFixed(4);
            
            const eurRate = egpRate / data.rates.EUR;
            document.getElementById('eur-buy').innerText = (eurRate - 0.12).toFixed(4);
            document.getElementById('eur-sell').innerText = (eurRate + 0.06).toFixed(4);
        } catch (e) {
            console.error("FX Load Failed");
        }
    }

    // 3. Automated PDF Extraction
    async function runExtraction() {
        const output = document.getElementById('output');
        const status = document.getElementById('status');

        try {
            const pdf = await pdfjsLib.getDocument(PDF_PATH).promise;
            status.innerText = `✅ Connected: ${pdf.numPages} Pages Synced`;

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                
                const rows = {};
                text.items.forEach(item => {
                    const y = Math.round(item.transform[5]);
                    if (!rows[y]) rows[y] = [];
                    rows[y].push({ x: item.transform[4], str: item.str.trim() });
                });

                let tableHtml = "";
                Object.keys(rows).sort((a, b) => b - a).forEach(y => {
                    const line = rows[y].sort((a, b) => a.x - b.x);
                    const lineStr = line.map(it => it.str).join(" ");
                    const nums = line.filter(it => /^-?[\d,.]+(\(.*\))?$/.test(it.str) && it.str.length > 1);

                    if (nums.length >= 2 && /[A-Za-z]/.test(lineStr)) {
                        tableHtml += `<tr>
                            <td style="font-weight:bold">${lineStr.replace(/[0-9,.( )]{2,}/g, '').trim()}</td>
                            <td style="text-align:right">${nums[0].str}</td>
                            <td style="text-align:right">${nums[nums.length-1].str}</td>
                        </tr>`;
                    }
                });

                if (tableHtml) {
                    output.innerHTML += `<div class="card">
                        <div style="padding:15px; background:#f8fafc; font-weight:bold; color:var(--cbe-blue)">Annex Table Page ${i}</div>
                        <table><thead><tr><th>Description</th><th>Previous</th><th>Current</th></tr></thead>
                        <tbody>${tableHtml}</tbody></table></div>`;
                }
            }
        } catch (e) {
            status.innerText = "❌ Master File Error. Ensure 'yoo.pdf' is in GitHub.";
        }
    }

    window.onload = runExtraction;
</script>
</body>
</html>
